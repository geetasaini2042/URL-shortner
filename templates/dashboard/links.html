{% extends "dashboard/base.html" %}

{% block title %}Links | Dashboard | spoo.me{% endblock %}

{% block head_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard/links.css') }}?v=1">
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard/url-modal.css') }}?v=1">
<script defer src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
<meta name="robots" content="noindex">
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <div class="page-header-text">
            <h1 class="page-title">All Links</h1>
            <p class="page-subtitle">View, filter, and organize all your shortened links below.</p>
        </div>
        <div class="page-header-actions">
            <button class="btn btn-primary" id="btn-create-link">
                <i class="ti ti-plus"></i>
                <span>Create Link</span>
            </button>
        </div>
    </div>
</div>

<div class="links-container surface">
    <div class="toolbar">
        <div class="filters compact">
            <div class="field search">
                <div class="search-input-wrapper">
                    <i class="ti ti-search search-icon"></i>
                    <input id="f-search" type="text" placeholder="Search alias or destination…" autocomplete="off">
                </div>
            </div>
        </div>
        <div class="toolbar-actions">
            <div class="options">
                <button id="btn-options" class="btn"><span class="label">Options</span><i
                        class="ti ti-adjustments"></i></button>
                <div id="options-dropdown" class="options-dropdown" style="display:none">
                    <div class="options-grid">
                        <div class="field">
                            <label>Status</label>
                            <div class="select-wrapper">
                                <select id="f-status">
                                    <option value="">All</option>
                                    <option value="ACTIVE">ACTIVE</option>
                                    <option value="INACTIVE">INACTIVE</option>
                                    <option value="EXPIRED">EXPIRED</option>
                                    <option value="BLOCKED">BLOCKED</option>
                                </select>
                                <i class="ti ti-chevron-down select-icon"></i>
                            </div>
                        </div>
                        <div class="field">
                            <label>Password</label>
                            <div class="seg seg--3" data-target="f-password">
                                <button type="button" data-value="true">Set</button>
                                <button type="button" data-value="false">Unset</button>
                                <button type="button" data-value="">All</button>
                                <span class="seg-indicator"></span>
                            </div>
                            <input type="hidden" id="f-password" value="">
                        </div>
                        <div class="field">
                            <label>Max clicks</label>
                            <div class="seg seg--3" data-target="f-maxclicks">
                                <button type="button" data-value="true">Set</button>
                                <button type="button" data-value="false">Unset</button>
                                <button type="button" data-value="">All</button>
                                <span class="seg-indicator"></span>
                            </div>
                            <input type="hidden" id="f-maxclicks" value="">
                        </div>
                        <div class="field">
                            <label>Created after</label>
                            <div class="datetime-wrapper">
                                <input id="f-created-after" type="datetime-local">
                                <i class="ti ti-calendar datetime-icon"></i>
                            </div>
                        </div>
                        <div class="field">
                            <label>Created before</label>
                            <div class="datetime-wrapper">
                                <input id="f-created-before" type="datetime-local">
                                <i class="ti ti-calendar datetime-icon"></i>
                            </div>
                        </div>
                        <div class="field">
                            <label>Sort by</label>
                            <div class="select-wrapper">
                                <select id="f-sortby">
                                    <option value="created_at">Created</option>
                                    <option value="last_click">Last click</option>
                                    <option value="total_clicks">Total clicks</option>
                                </select>
                                <i class="ti ti-chevron-down select-icon"></i>
                            </div>
                        </div>
                        <div class="field">
                            <label>Order</label>
                            <div class="seg seg--2" data-target="f-order">
                                <button type="button" data-value="descending">Descending</button>
                                <button type="button" data-value="ascending">Ascending</button>
                                <span class="seg-indicator"></span>
                            </div>
                            <input type="hidden" id="f-order" value="descending">
                        </div>
                        <div class="field">
                            <label>Page size</label>
                            <div class="select-wrapper">
                                <select id="f-pagesize">
                                    <option value="10">10</option>
                                    <option value="20" selected>20</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                                <i class="ti ti-chevron-down select-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="options-actions">
                        <button id="btn-apply" class="btn btn-primary">Apply</button>
                        <button id="btn-reset" class="btn btn-ghost">Reset</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="list-container" class="list-container">
        <div id="list-loading" class="loading">Loading…</div>
        <div id="list-empty" class="empty" style="display:none">
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="ti ti-link-off"></i>
                </div>
                <h3 class="empty-title">Oops! Nothing here yet</h3>
                <p class="empty-message">Looks like you haven't created any links yet, or your search didn't match
                    anything.</p>
            </div>
        </div>

        <div class="links-table" id="links-table" style="display:none">
            <div class="table-header">
                <div class="header-cell col-short-url">Short URL</div>
                <div class="header-cell col-long-url">Destination</div>
                <div class="header-cell col-created">Created</div>
                <div class="header-cell col-last-click">Last Click</div>
                <div class="header-cell col-clicks">Clicks</div>
                <div class="header-cell col-attributes">Attributes</div>
            </div>
            <div id="links-list" class="table-body"></div>
        </div>
    </div>

    <footer class="pagination-bar" id="pagination" style="display:none"></footer>
</div>

<template id="tpl-link-item">
    <div class="table-row fade-in">
        <div class="table-cell col-short-url">
            <a class="link-short" target="_blank" rel="noopener"></a>
        </div>
        <div class="table-cell col-long-url">
            <div class="link-long" title=""></div>
        </div>
        <div class="table-cell col-created">
            <span class="created-date"></span>
        </div>
        <div class="table-cell col-last-click">
            <span class="last-click-date"></span>
        </div>
        <div class="table-cell col-clicks">
            <span class="total-clicks-count"></span>
        </div>
        <div class="table-cell col-attributes">
            <div class="attribute-badges">
                <span class="badge badge-status badge-active tooltip-trigger" data-tooltip="Active"
                    style="display:none">
                    <i class="ti ti-circle-check"></i>
                </span>
                <span class="badge badge-status badge-inactive tooltip-trigger" data-tooltip="Inactive"
                    style="display:none">
                    <i class="ti ti-circle-x"></i>
                </span>
                <span class="badge badge-password tooltip-trigger" data-tooltip="Password protected"
                    style="display:none">
                    <i class="ti ti-lock"></i>
                </span>
                <span class="badge badge-max-clicks tooltip-trigger" data-tooltip="Max clicks set" style="display:none">
                    <i class="ti ti-click"></i>
                </span>
                <span class="badge badge-private tooltip-trigger" data-tooltip="Private stats" style="display:none">
                    <i class="ti ti-eye-off"></i>
                </span>
            </div>
        </div>
    </div>
</template>

<!-- Create Link Modal -->
<div id="create-link-modal" class="modal">
    <div class="modal-backdrop"></div>
    <div class="modal-container">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title-section">
                    <h2 class="modal-title">Create New Link</h2>
                    <p class="modal-subtitle">Create a new shortened URL with custom settings</p>
                </div>
                <button class="modal-close" type="button" aria-label="Close modal">
                    <i class="ti ti-x"></i>
                </button>
            </div>

            <div class="modal-body">
                <form id="create-link-form">
                    <div class="tabs" data-active="0">
                        <button type="button" class="tab active" data-tab="basic">
                            <i class="ti ti-link"></i>
                            <span>Basic</span>
                        </button>
                        <button type="button" class="tab" data-tab="security">
                            <i class="ti ti-shield-lock"></i>
                            <span>Security</span>
                        </button>
                        <button type="button" class="tab" data-tab="advanced">
                            <i class="ti ti-settings"></i>
                            <span>Advanced</span>
                        </button>
                    </div>

                    <div class="tab-content-container">
                        <!-- Basic Tab -->
                        <div class="tab-content active" data-tab="basic">
                            <div class="form-grid">
                                <div class="field">
                                    <label for="create-long-url">Destination URL</label>
                                    <input type="url" id="create-long-url" name="long_url"
                                        placeholder="https://example.com" autocomplete="off" required>
                                    <small class="field-hint">The URL users will be redirected to</small>
                                </div>

                                <div class="field">
                                    <label for="create-alias">Custom Alias (optional)</label>
                                    <div class="input-group">
                                        <span class="input-prefix">{{ host_url }}</span>
                                        <input type="text" id="create-alias" name="alias" placeholder="my-link"
                                            autocomplete="off">
                                    </div>
                                    <small class="field-hint">Leave empty for auto-generated alias</small>
                                </div>
                            </div>
                        </div>

                        <!-- Security Tab -->
                        <div class="tab-content" data-tab="security">
                            <div class="form-grid">
                                <div class="field">
                                    <label for="create-password">Password Protection (optional)</label>
                                    <input type="password" id="create-password" name="password"
                                        placeholder="Enter password" autocomplete="new-password">
                                    <small class="field-hint">Require users to enter a password to access the
                                        link</small>
                                </div>

                                <div class="field">
                                    <div class="checkbox-field">
                                        <input type="checkbox" id="create-private-stats" name="private_stats" checked>
                                        <label for="create-private-stats" class="checkbox-label">
                                            <span class="checkbox-indicator"></span>
                                            <div class="checkbox-content">
                                                <span class="checkbox-title">Private Statistics</span>
                                                <small class="checkbox-desc">Hide click statistics from public
                                                    view</small>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Tab -->
                        <div class="tab-content" data-tab="advanced">
                            <div class="form-grid">
                                <div class="field">
                                    <label for="create-max-clicks">Maximum Clicks (optional)</label>
                                    <input type="number" id="create-max-clicks" name="max_clicks"
                                        placeholder="Leave empty for unlimited" min="1">
                                    <small class="field-hint">Link will be disabled after reaching this limit</small>
                                </div>

                                <div class="field">
                                    <label for="create-expire-after">Expiration Date (optional)</label>
                                    <input type="datetime-local" id="create-expire-after" name="expire_after">
                                    <small class="field-hint">Link will be disabled after this date</small>
                                </div>

                                <div class="field">
                                    <div class="checkbox-field">
                                        <input type="checkbox" id="create-block-bots" name="block_bots">
                                        <label for="create-block-bots" class="checkbox-label">
                                            <span class="checkbox-indicator"></span>
                                            <div class="checkbox-content">
                                                <span class="checkbox-title">Block Bots</span>
                                                <small class="checkbox-desc">Prevent automated bot traffic from
                                                    accessing this link</small>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="btn-cancel-create">
                    <span>Cancel</span>
                </button>
                <button type="submit" class="btn btn-primary" id="btn-create-submit" form="create-link-form">
                    <i class="ti ti-plus"></i>
                    <span>Create Link</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Link Creation Success Modal -->
<div id="link-success-modal" class="modal">
    <div class="modal-backdrop"></div>
    <div class="modal-container modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title-section">
                    <div class="modal-icon success-icon">
                        <i class="ti ti-check"></i>
                    </div>
                    <div>
                        <h2 class="modal-title">Link Created!</h2>
                        <p class="modal-subtitle">Your shortened link is ready to use</p>
                    </div>
                </div>
                <button class="modal-close" type="button" aria-label="Close modal" onclick="closeLinkSuccessModal()">
                    <i class="ti ti-x"></i>
                </button>
            </div>

            <div class="modal-body">
                <div class="success-content">
                    <div class="link-display">
                        <div class="field">
                            <label>Your shortened link</label>
                            <div class="link-result">
                                <input id="created-link-input" class="link-input" type="text" readonly value=""
                                    aria-label="Created short link">
                                <button class="copy-btn" id="btn-copy-created-link" type="button">
                                    <i class="ti ti-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="qr-block">
                        <div class="qr-container" id="qr-container">
                            <img id="created-link-qr" class="qr-image" src="" alt="QR code for the short link"
                                loading="lazy">
                            <div id="qr-overlay" class="qr-overlay">
                                <i class="ti ti-download"></i>
                                <span>Download</span>
                            </div>
                        </div>
                    </div>

                    <div class="link-actions">
                        <a id="created-link-visit" href="" target="_blank" rel="noopener" class="btn btn-ghost">
                            <i class="ti ti-external-link"></i>
                            <span>Visit Link</span>
                        </a>
                        <button class="btn btn-ghost" onclick="createAnotherLink()" type="button">
                            <i class="ti ti-plus"></i>
                            <span>Create Another</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- URL Management Modal -->
<div id="url-management-modal" class="modal">
    <div class="modal-backdrop"></div>
    <div class="modal-container">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title-section">
                    <h2 class="modal-title">Manage URL</h2>
                    <p class="modal-subtitle">Edit your shortened URL settings and configuration</p>
                </div>
                <button class="modal-close" type="button" aria-label="Close modal">
                    <i class="ti ti-x"></i>
                </button>
            </div>

            <div class="modal-body">
                <form id="url-edit-form">
                    <div class="tabs" data-active="0">
                        <button type="button" class="tab active" data-tab="basic">
                            <i class="ti ti-link"></i>
                            <span>Basic</span>
                        </button>
                        <button type="button" class="tab" data-tab="security">
                            <i class="ti ti-shield-lock"></i>
                            <span>Security</span>
                        </button>
                        <button type="button" class="tab" data-tab="advanced">
                            <i class="ti ti-settings"></i>
                            <span>Advanced</span>
                        </button>
                    </div>

                    <div class="tab-content-container">
                        <!-- Basic Tab -->
                        <div class="tab-content active" data-tab="basic">
                            <div class="form-grid">
                                <div class="field">
                                    <label for="edit-alias">Short URL Alias</label>
                                    <div class="input-group">
                                        <span class="input-prefix">{{ host_url }}</span>
                                        <input type="text" id="edit-alias" name="alias" placeholder="custom-alias"
                                            autocomplete="off">
                                    </div>
                                    <small class="field-hint">Choose a custom alias for your short URL</small>
                                </div>

                                <div class="field">
                                    <label for="edit-long-url">Destination URL</label>
                                    <input type="url" id="edit-long-url" name="long_url"
                                        placeholder="https://example.com" autocomplete="off">
                                    <small class="field-hint">The URL users will be redirected to</small>
                                </div>
                            </div>
                        </div>

                        <!-- Security Tab -->
                        <div class="tab-content" data-tab="security">
                            <div class="form-grid">
                                <div class="field">
                                    <label for="edit-password">Password Protection</label>
                                    <div class="password-field-group">
                                        <input type="password" id="edit-password" name="password"
                                            placeholder="Enter new password" autocomplete="new-password">
                                        <small class="password-status" id="password-status"></small>
                                        <div class="checkbox-field">
                                            <input type="checkbox" id="remove-password-checkbox">
                                            <label for="remove-password-checkbox" class="checkbox-label">
                                                <span class="checkbox-indicator"></span>
                                                <div class="checkbox-content">
                                                    <span class="checkbox-title">Remove password protection</span>
                                                    <small class="checkbox-desc">Disable password requirement for this
                                                        URL</small>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    <small class="field-hint">Check "Remove password protection" to disable, or enter a
                                        new password to change it</small>
                                </div>

                                <div class="field">
                                    <div class="checkbox-field">
                                        <input type="checkbox" id="edit-private-stats" name="private_stats">
                                        <label for="edit-private-stats" class="checkbox-label">
                                            <span class="checkbox-indicator"></span>
                                            <div class="checkbox-content">
                                                <span class="checkbox-title">Private Statistics</span>
                                                <small class="checkbox-desc">Hide click statistics from public
                                                    view</small>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Tab -->
                        <div class="tab-content" data-tab="advanced">
                            <div class="form-grid">
                                <div class="field">
                                    <label for="edit-max-clicks">Maximum Clicks</label>
                                    <input type="number" id="edit-max-clicks" name="max_clicks"
                                        placeholder="Leave empty for unlimited" min="1">
                                    <small class="field-hint">URL will be disabled after reaching this limit</small>
                                </div>

                                <div class="field">
                                    <label for="edit-expire-after">Expiration Date</label>
                                    <input type="datetime-local" id="edit-expire-after" name="expire_after">
                                    <small class="field-hint">URL will be disabled after this date</small>
                                </div>

                                <div class="field">
                                    <div class="checkbox-field">
                                        <input type="checkbox" id="edit-block-bots" name="block_bots">
                                        <label for="edit-block-bots" class="checkbox-label">
                                            <span class="checkbox-indicator"></span>
                                            <div class="checkbox-content">
                                                <span class="checkbox-title">Block Bots</span>
                                                <small class="checkbox-desc">Prevent automated bot traffic from
                                                    accessing this URL</small>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> <!-- Close tab-content-container -->
                </form>
            </div>

            <div class="modal-footer">
                <div class="footer-actions">
                    <div class="footer-actions-left">
                        <button type="button" class="btn btn-danger" id="btn-delete-url">
                            <i class="ti ti-trash"></i>
                            <span>Delete</span>
                        </button>
                        <button type="button" class="btn btn-warning" id="btn-deactivate">
                            <i class="ti ti-player-pause"></i>
                            <span>Deactivate</span>
                        </button>
                    </div>
                    <div class="footer-actions-right">
                        <button type="submit" class="btn btn-primary" id="btn-save">
                            <span>Save Changes</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-confirmation-modal" class="modal modal-danger">
    <div class="modal-backdrop"></div>
    <div class="modal-container modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title-section">
                    <div class="modal-icon">
                        <i class="ti ti-alert-triangle"></i>
                    </div>
                    <div>
                        <h2 class="modal-title">Delete URL</h2>
                        <p class="modal-subtitle">This action cannot be undone</p>
                    </div>
                </div>
            </div>

            <div class="modal-body">
                <div class="warning-content">
                    <p>You are about to permanently delete this short URL:</p>
                    <div class="url-preview">
                        <strong id="delete-url-preview"></strong>
                    </div>
                    <p>To confirm deletion, please type the short URL alias below:</p>
                    <div class="field">
                        <input type="text" id="delete-confirmation-input" placeholder="Enter alias to confirm"
                            autocomplete="off">
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="btn-cancel-delete">
                    <span>Cancel</span>
                </button>
                <button type="button" class="btn btn-danger" id="btn-confirm-delete" disabled>
                    <i class="ti ti-trash"></i>
                    <span>Delete Permanently</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Pass host URL to the dashboard script
    window.dashboardConfig = {
        hostUrl: "{{ host_url }}"
    };
</script>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}?v=1" defer></script>
<script src="{{ url_for('static', filename='js/url-manager.js') }}?v=1" defer></script>
<script>
    // Initialize segmented controls for the options dropdown
    document.addEventListener('DOMContentLoaded', function () {
        function initSegments() {
            const segs = document.querySelectorAll('.seg');
            segs.forEach(seg => {
                const targetId = seg.getAttribute('data-target');
                const hidden = document.getElementById(targetId);
                const buttons = Array.from(seg.querySelectorAll('button[data-value]'));
                const indexByValue = new Map(buttons.map((b, i) => [b.getAttribute('data-value'), i]));

                function apply(value) {
                    if (hidden) { hidden.value = value; }
                    const idx = indexByValue.has(value) ? indexByValue.get(value) : 0;
                    seg.setAttribute('data-active', String(idx));

                    // Update button states
                    buttons.forEach((btn, i) => {
                        btn.classList.toggle('active', i === idx);
                    });
                }

                apply(hidden ? hidden.value : '');
                buttons.forEach(btn => btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    apply(btn.getAttribute('data-value') || '');
                }));
            });
        }

        initSegments();

        // Initialize datetime icon clicks
        initDateTimeIcons();
    });

    function initDateTimeIcons() {
        const datetimeIcons = document.querySelectorAll('.datetime-icon');

        datetimeIcons.forEach(icon => {
            icon.addEventListener('click', function () {
                const input = this.previousElementSibling;
                if (input && input.type === 'datetime-local') {
                    input.focus();
                    input.showPicker?.();
                }
            });
        });
    }

    // Global confetti management
    window.confettiAnimationId = null;
    window.confettiActive = false;

    // Create Link Modal Functions
    function openCreateLinkModal() {
        const modal = document.getElementById('create-link-modal');

        if (modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Focus on the first input
            setTimeout(() => {
                const firstInput = modal.querySelector('#create-long-url');
                if (firstInput) firstInput.focus();
            }, 100);
        }
    }

    function closeCreateLinkModal() {
        const modal = document.getElementById('create-link-modal');
        if (modal) {
            modal.classList.remove('active');
            document.body.style.overflow = '';

            // Reset form
            const form = document.getElementById('create-link-form');
            if (form) form.reset();

            // Clear any error states
            const errorFields = modal.querySelectorAll('.error');
            errorFields.forEach(field => field.classList.remove('error'));
            const errorMessages = modal.querySelectorAll('.field-error');
            errorMessages.forEach(msg => msg.remove());

            // Reset to first tab
            const tabs = modal.querySelectorAll('.tab');
            const contents = modal.querySelectorAll('.tab-content');
            tabs.forEach((tab, i) => {
                tab.classList.toggle('active', i === 0);
            });
            contents.forEach((content, i) => {
                content.classList.toggle('active', i === 0);
            });
        }
    }

    function openLinkSuccessModal(shortUrl, linkData) {
        const modal = document.getElementById('link-success-modal');
        const input = document.getElementById('created-link-input');
        const visitLink = document.getElementById('created-link-visit');
        const qrImg = document.getElementById('created-link-qr');

        if (modal && input && visitLink) {
            input.value = shortUrl;
            visitLink.href = shortUrl;

            // Show loading state for QR code
            if (qrImg) {
                qrImg.src = "";
                qrImg.style.animation = "qr-loading 1.5s infinite";

                // Load QR code with delay to show loading animation
                setTimeout(() => {
                    const enc = encodeURIComponent(shortUrl);
                    qrImg.src = `https://qr.spoo.me/gradient?text=${enc}&width=280&height=280&gradient1=1d1919&gradient2=322c29`;

                    // Set up QR code interactions when loaded
                    qrImg.onload = function () {
                        qrImg.style.animation = "none";
                        setupQRCodeInteractions();
                    };
                }, 800);
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Auto-copy the URL to clipboard
            setTimeout(() => {
                try {
                    navigator.clipboard.writeText(shortUrl).then(() => {
                        if (typeof showNotification === 'function') {
                            showNotification('Link automatically copied to clipboard!', 'success');
                        }
                        // Update the copy button to show copied state
                        const copyBtn = document.getElementById('btn-copy-created-link');
                        const icon = copyBtn?.querySelector('i');
                        if (copyBtn) {
                            copyBtn.classList.add('copied');
                            if (icon) {
                                icon.className = 'ti ti-check';
                            }
                            setTimeout(() => {
                                copyBtn.classList.remove('copied');
                                if (icon) {
                                    icon.className = 'ti ti-copy';
                                }
                            }, 2000);
                        }
                    }).catch(() => {
                        // Fallback for older browsers
                        input.select();
                        input.setSelectionRange(0, 99999);
                        document.execCommand('copy');
                        if (typeof showNotification === 'function') {
                            showNotification('Link automatically copied to clipboard!', 'success');
                        }
                        // Update the copy button to show copied state
                        const copyBtn = document.getElementById('btn-copy-created-link');
                        const icon = copyBtn?.querySelector('i');
                        if (copyBtn) {
                            copyBtn.classList.add('copied');
                            if (icon) {
                                icon.className = 'ti ti-check';
                            }
                            setTimeout(() => {
                                copyBtn.classList.remove('copied');
                                if (icon) {
                                    icon.className = 'ti ti-copy';
                                }
                            }, 2000);
                        }
                    });
                } catch (err) {
                    console.log('Auto-copy failed:', err);
                }
            }, 500);

            // Trigger confetti effect
            setTimeout(() => {
                if (window.confetti && !window.confettiActive) {
                    // Check for reduced motion preference
                    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

                    if (!prefersReducedMotion) {
                        window.confettiActive = true;

                        // Launch confetti from multiple directions with higher z-index
                        const duration = 3000;
                        const end = Date.now() + duration;

                        // Initial big burst
                        confetti({
                            particleCount: 100,
                            spread: 70,
                            origin: { y: 0.6 },
                            colors: ['#6366f1', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b'],
                            zIndex: 10000
                        });

                        // Continuous smaller bursts
                        (function frame() {
                            if (!window.confettiActive) return; // Stop if confetti was disabled

                            confetti({
                                particleCount: 3,
                                angle: 60,
                                spread: 55,
                                origin: { x: 0, y: 0.7 },
                                colors: ['#6366f1', '#8b5cf6', '#06b6d4'],
                                zIndex: 10000
                            });
                            confetti({
                                particleCount: 3,
                                angle: 120,
                                spread: 55,
                                origin: { x: 1, y: 0.7 },
                                colors: ['#6366f1', '#8b5cf6', '#06b6d4'],
                                zIndex: 10000
                            });

                            if (Date.now() < end && window.confettiActive) {
                                window.confettiAnimationId = requestAnimationFrame(frame);
                            } else {
                                window.confettiAnimationId = null;
                                window.confettiActive = false;
                            }
                        }());
                    }
                }
            }, 100);
        }
    }

    function closeLinkSuccessModal() {
        const modal = document.getElementById('link-success-modal');
        if (modal) {
            modal.classList.remove('active');
            document.body.style.overflow = '';

            // Stop confetti animation immediately
            window.confettiActive = false;

            if (window.confettiAnimationId) {
                cancelAnimationFrame(window.confettiAnimationId);
                window.confettiAnimationId = null;
            }

            // Clear all existing confetti
            if (window.confetti && window.confetti.reset) {
                confetti.reset();
            }
        }
    }

    function copyCreatedLinkToClipboard() {
        try {
            const input = document.getElementById('created-link-input');
            const btn = document.getElementById('btn-copy-created-link');
            const icon = btn?.querySelector('i');

            navigator.clipboard.writeText(input.value).then(() => {
                btn?.classList.add('copied');
                if (icon) {
                    icon.className = 'ti ti-check';
                }
                if (typeof showNotification === 'function') {
                    showNotification('Link copied to clipboard again!', 'success');
                }
                setTimeout(() => {
                    btn?.classList.remove('copied');
                    if (icon) {
                        icon.className = 'ti ti-copy';
                    }
                }, 1200);
            }).catch(() => {
                input.select();
                input.setSelectionRange(0, 99999);
                document.execCommand('copy');
                btn?.classList.add('copied');
                if (icon) {
                    icon.className = 'ti ti-check';
                }
                if (typeof showNotification === 'function') {
                    showNotification('Link copied to clipboard again!', 'success');
                }
                setTimeout(() => {
                    btn?.classList.remove('copied');
                    if (icon) {
                        icon.className = 'ti ti-copy';
                    }
                }, 1200);
            });
        } catch (_) {
            console.log('Copy failed');
        }
    }

    function createAnotherLink() {
        closeLinkSuccessModal();
        openCreateLinkModal();
    }

    // QR Code interaction setup (similar to result.html)
    function setupQRCodeInteractions() {
        const qrContainer = document.getElementById('qr-container');
        const qrOverlay = document.getElementById('qr-overlay');

        if (qrContainer && qrOverlay) {
            qrContainer.style.cursor = "pointer";

            qrContainer.addEventListener("mouseenter", function () {
                qrOverlay.style.opacity = "1";
                qrOverlay.style.visibility = "visible";
            });

            qrContainer.addEventListener("mouseleave", function () {
                qrOverlay.style.opacity = "0";
                qrOverlay.style.visibility = "hidden";
            });

            qrContainer.addEventListener("click", function () {
                downloadQRCodeFromModal();
            });
        }
    }

    // QR Code download function (similar to result.html)
    function downloadQRCodeFromModal() {
        const qrImg = document.getElementById("created-link-qr");
        if (!qrImg || !qrImg.src) return;

        const qrCodeSrc = qrImg.src;
        const link = document.createElement("a");

        const xhr = new XMLHttpRequest();
        xhr.responseType = "blob";
        xhr.onload = function () {
            const reader = new FileReader();
            reader.onloadend = function () {
                link.href = reader.result;
                link.download = "qrcode.png";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Show success notification
                if (typeof showNotification === 'function') {
                    showNotification('QR code downloaded successfully!', 'success');
                }
            };
            reader.readAsDataURL(xhr.response);
        };
        xhr.onerror = function () {
            if (typeof showNotification === 'function') {
                showNotification('Failed to download QR code', 'error');
            }
        };
        xhr.open("GET", qrCodeSrc);
        xhr.send();
    }

    // Form Validation Functions
    function validateUrl(url) {
        if (!url) return { valid: false, message: 'URL is required' };

        // Basic URL pattern check
        const urlPattern = /^https?:\/\/.+/i;
        if (!urlPattern.test(url)) {
            return { valid: false, message: 'URL must start with http:// or https://' };
        }

        // Check if URL contains spoo.me (not allowed)
        if (url.toLowerCase().includes('spoo.me')) {
            return { valid: false, message: 'Cannot shorten spoo.me URLs' };
        }

        return { valid: true, message: '' };
    }

    function validateAlias(alias) {
        if (!alias) return { valid: true, message: '' }; // Optional field

        // Check pattern: alphanumeric, underscore, hyphen only
        const aliasPattern = /^[a-zA-Z0-9_-]+$/;
        if (!aliasPattern.test(alias)) {
            return { valid: false, message: 'Alias can only contain letters, numbers, underscores, and hyphens' };
        }

        if (alias.length > 16) {
            return { valid: false, message: 'Alias cannot be longer than 16 characters' };
        }

        return { valid: true, message: '' };
    }

    function validatePassword(password) {
        if (!password) return { valid: true, message: '' }; // Optional field

        if (password.length < 8) {
            return { valid: false, message: 'Password must be at least 8 characters long' };
        }

        if (!/[a-zA-Z]/.test(password)) {
            return { valid: false, message: 'Password must contain at least one letter' };
        }

        if (!/\d/.test(password)) {
            return { valid: false, message: 'Password must contain at least one number' };
        }

        if (!/[@.]/.test(password)) {
            return { valid: false, message: 'Password must contain @ or .' };
        }

        if (/[@.]{2}/.test(password)) {
            return { valid: false, message: 'Password cannot have consecutive @ or . characters' };
        }

        return { valid: true, message: '' };
    }

    function validateMaxClicks(maxClicks) {
        if (!maxClicks) return { valid: true, message: '' }; // Optional field

        const clicks = parseInt(maxClicks);
        if (isNaN(clicks) || clicks <= 0) {
            return { valid: false, message: 'Max clicks must be a positive number' };
        }

        return { valid: true, message: '' };
    }

    function validateExpireAfter(expireAfter) {
        if (!expireAfter) return { valid: true, message: '' }; // Optional field

        const expireDate = new Date(expireAfter);
        const now = new Date();

        if (expireDate <= now) {
            return { valid: false, message: 'Expiration date must be in the future' };
        }

        return { valid: true, message: '' };
    }

    function showFieldError(fieldId, message) {
        const field = document.getElementById(fieldId);
        if (!field) return;

        // Remove existing error
        const existingError = field.parentNode.querySelector('.field-error');
        if (existingError) existingError.remove();

        if (message) {
            // Add error styling
            field.classList.add('error');

            // Add error message
            const errorEl = document.createElement('small');
            errorEl.className = 'field-error';
            errorEl.textContent = message;
            field.parentNode.appendChild(errorEl);
        } else {
            // Remove error styling
            field.classList.remove('error');
        }
    }

    function validateForm() {
        let isValid = true;

        // Get form values
        const longUrl = document.getElementById('create-long-url').value.trim();
        const alias = document.getElementById('create-alias').value.trim();
        const password = document.getElementById('create-password').value;
        const maxClicks = document.getElementById('create-max-clicks').value;
        const expireAfter = document.getElementById('create-expire-after').value;

        // Validate each field
        const urlValidation = validateUrl(longUrl);
        const aliasValidation = validateAlias(alias);
        const passwordValidation = validatePassword(password);
        const maxClicksValidation = validateMaxClicks(maxClicks);
        const expireAfterValidation = validateExpireAfter(expireAfter);

        // Show errors
        showFieldError('create-long-url', urlValidation.valid ? '' : urlValidation.message);
        showFieldError('create-alias', aliasValidation.valid ? '' : aliasValidation.message);
        showFieldError('create-password', passwordValidation.valid ? '' : passwordValidation.message);
        showFieldError('create-max-clicks', maxClicksValidation.valid ? '' : maxClicksValidation.message);
        showFieldError('create-expire-after', expireAfterValidation.valid ? '' : expireAfterValidation.message);

        return urlValidation.valid && aliasValidation.valid && passwordValidation.valid &&
            maxClicksValidation.valid && expireAfterValidation.valid;
    }

    // Form Submission
    async function submitCreateForm(event) {
        event.preventDefault();

        if (!validateForm()) {
            return;
        }

        const submitBtn = document.getElementById('btn-create-submit');
        const originalText = submitBtn.innerHTML;

        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="ti ti-loader-2 spinning"></i><span>Creating...</span>';

        try {
            // Prepare form data
            const formData = {
                long_url: document.getElementById('create-long-url').value.trim(),
                alias: document.getElementById('create-alias').value.trim() || undefined,
                password: document.getElementById('create-password').value || undefined,
                max_clicks: document.getElementById('create-max-clicks').value ?
                    parseInt(document.getElementById('create-max-clicks').value) : undefined,
                expire_after: document.getElementById('create-expire-after').value || undefined,
                block_bots: document.getElementById('create-block-bots').checked,
                private_stats: document.getElementById('create-private-stats').checked
            };

            // Remove undefined values
            Object.keys(formData).forEach(key => {
                if (formData[key] === undefined) {
                    delete formData[key];
                }
            });

            // Submit to API
            const response = await authFetch('/api/v1/shorten', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (response.ok) {
                // Success - close create modal and show success modal
                closeCreateLinkModal();
                openLinkSuccessModal(result.short_url, result);

                // Refresh the links list to show the new URL
                if (typeof window.fetchData === 'function') {
                    setTimeout(() => {
                        window.fetchData();
                    }, 500); // Small delay to ensure any confetti animation doesn't interfere
                }

                // Show success notification
                if (typeof showNotification === 'function') {
                    showNotification('Link created successfully!', 'success');
                }
            } else {
                // Handle API errors
                handleApiError(result);
            }

        } catch (error) {
            console.error('Error creating link:', error);
            if (typeof showNotification === 'function') {
                showNotification('Failed to create link. Please try again.', 'error');
            }
        } finally {
            // Reset button state
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    }

    function handleApiError(result) {
        // Handle field-specific errors
        if (result.field) {
            const fieldMap = {
                'long_url': 'create-long-url',
                'url': 'create-long-url',
                'alias': 'create-alias',
                'password': 'create-password',
                'max_clicks': 'create-max-clicks',
                'expire_after': 'create-expire-after'
            };

            const fieldId = fieldMap[result.field];
            if (fieldId) {
                showFieldError(fieldId, result.error);
                return;
            }
        }

        // Handle general errors
        let errorMessage = result.error || 'An error occurred while creating the link';

        // Customize common error messages
        if (errorMessage.includes('Alias already exists')) {
            showFieldError('create-alias', 'This alias is already taken. Please choose another.');
        } else if (errorMessage.includes('Blocked URL')) {
            showFieldError('create-long-url', 'This URL is not allowed to be shortened.');
        } else if (errorMessage.includes('api key lacks required scope')) {
            errorMessage = 'You do not have permission to create links. Please check your account settings.';
        } else if (errorMessage.includes('ratelimit exceeded')) {
            errorMessage = 'You are creating links too quickly. Please wait a moment and try again.';
        }

        // Show general notification
        if (typeof showNotification === 'function') {
            showNotification(errorMessage, 'error');
        }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function () {
        // Create Link button
        const createBtn = document.getElementById('btn-create-link');
        if (createBtn) {
            createBtn.addEventListener('click', function (e) {
                e.preventDefault();
                openCreateLinkModal();
            });
        }

        // Modal close buttons
        const cancelBtn = document.getElementById('btn-cancel-create');
        if (cancelBtn) {
            cancelBtn.addEventListener('click', closeCreateLinkModal);
        }

        // Form submission
        const createForm = document.getElementById('create-link-form');
        if (createForm) {
            createForm.addEventListener('submit', submitCreateForm);
        }

        // Real-time validation on input
        const inputs = ['create-long-url', 'create-alias', 'create-password', 'create-max-clicks', 'create-expire-after'];
        inputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('blur', function () {
                    // Clear previous errors when user starts typing
                    showFieldError(inputId, '');
                });
            }
        });

        // Close modal on backdrop click
        const modal = document.getElementById('create-link-modal');
        if (modal) {
            modal.addEventListener('click', function (e) {
                if (e.target === modal || e.target.classList.contains('modal-backdrop')) {
                    closeCreateLinkModal();
                }
            });
        }

        // Close modal on X button
        const closeBtn = modal?.querySelector('.modal-close');
        if (closeBtn) {
            closeBtn.addEventListener('click', closeCreateLinkModal);
        }

        // Tab switching for create modal
        const createTabs = document.querySelectorAll('#create-link-modal .tab');
        createTabs.forEach(tab => {
            tab.addEventListener('click', function () {
                const targetTab = this.dataset.tab;
                const modal = document.getElementById('create-link-modal');

                // Update tab states
                modal.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                modal.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                this.classList.add('active');
                modal.querySelector(`[data-tab="${targetTab}"].tab-content`).classList.add('active');
            });
        });

        // ESC key to close modals
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                const createModal = document.getElementById('create-link-modal');
                const successModal = document.getElementById('link-success-modal');

                if (successModal?.classList.contains('active')) {
                    closeLinkSuccessModal();
                } else if (createModal?.classList.contains('active')) {
                    closeCreateLinkModal();
                }
            }
        });

        // Close modal on backdrop click for success modal
        const successModal = document.getElementById('link-success-modal');
        if (successModal) {
            successModal.addEventListener('click', function (e) {
                if (e.target === successModal || e.target.classList.contains('modal-backdrop')) {
                    closeLinkSuccessModal();
                }
            });
        }

        // Success modal actions: copy (download now handled by QR hover overlay)
        const copyBtn = document.getElementById('btn-copy-created-link');
        copyBtn?.addEventListener('click', copyCreatedLinkToClipboard);
    });
</script>
{% endblock %}